DROP DATABASE IF EXISTS TPCH;
CREATE DATABASE TPCH;
CREATE TABLE TPCH.NATION  ( N_NATIONKEY  INTEGER NOT NULL,
                            N_NAME       CHAR(25) NOT NULL,
                            N_REGIONKEY  INTEGER NOT NULL,
                            N_COMMENT    VARCHAR(152));

CREATE TABLE TPCH.REGION  ( R_REGIONKEY  INTEGER NOT NULL,
                            R_NAME       CHAR(25) NOT NULL,
                            R_COMMENT    VARCHAR(152));

CREATE TABLE TPCH.PART  ( P_PARTKEY     INTEGER NOT NULL,
                          P_NAME        VARCHAR(55) NOT NULL,
                          P_MFGR        CHAR(25) NOT NULL,
                          P_BRAND       CHAR(10) NOT NULL,
                          P_TYPE        VARCHAR(25) NOT NULL,
                          P_SIZE        INTEGER NOT NULL,
                          P_CONTAINER   CHAR(10) NOT NULL,
                          P_RETAILPRICE DECIMAL(15,2) NOT NULL,
                          P_COMMENT     VARCHAR(23) NOT NULL );

CREATE TABLE TPCH.SUPPLIER ( S_SUPPKEY     INTEGER NOT NULL,
                             S_NAME        CHAR(25) NOT NULL,
                             S_ADDRESS     VARCHAR(40) NOT NULL,
                             S_NATIONKEY   INTEGER NOT NULL,
                             S_PHONE       CHAR(15) NOT NULL,
                             S_ACCTBAL     DECIMAL(15,2) NOT NULL,
                             S_COMMENT     VARCHAR(101) NOT NULL);

CREATE TABLE TPCH.PARTSUPP ( PS_PARTKEY     INTEGER NOT NULL,
                             PS_SUPPKEY     INTEGER NOT NULL,
                             PS_AVAILQTY    INTEGER NOT NULL,
                             PS_SUPPLYCOST  DECIMAL(15,2)  NOT NULL,
                             PS_COMMENT     VARCHAR(199) NOT NULL );

CREATE TABLE TPCH.CUSTOMER ( C_CUSTKEY     INTEGER NOT NULL,
                             C_NAME        VARCHAR(25) NOT NULL,
                             C_ADDRESS     VARCHAR(40) NOT NULL,
                             C_NATIONKEY   INTEGER NOT NULL,
                             C_PHONE       CHAR(15) NOT NULL,
                             C_ACCTBAL     DECIMAL(15,2)   NOT NULL,
                             C_MKTSEGMENT  CHAR(10) NOT NULL,
                             C_COMMENT     VARCHAR(117) NOT NULL);

CREATE TABLE TPCH.ORDERS  ( O_ORDERKEY       INTEGER NOT NULL,
                           O_CUSTKEY        INTEGER NOT NULL,
                           O_ORDERSTATUS    CHAR(1) NOT NULL,
                           O_TOTALPRICE     DECIMAL(15,2) NOT NULL,
                           O_ORDERDATE      DATE NOT NULL,
                           O_ORDERPRIORITY  CHAR(15) NOT NULL,  
                           O_CLERK          CHAR(15) NOT NULL, 
                           O_SHIPPRIORITY   INTEGER NOT NULL,
                           O_COMMENT        VARCHAR(79) NOT NULL);

CREATE TABLE TPCH.LINEITEM ( L_ORDERKEY    INTEGER NOT NULL,
                             L_PARTKEY     INTEGER NOT NULL,
                             L_SUPPKEY     INTEGER NOT NULL,
                             L_LINENUMBER  INTEGER NOT NULL,
                             L_QUANTITY    DECIMAL(15,2) NOT NULL,
                             L_EXTENDEDPRICE  DECIMAL(15,2) NOT NULL,
                             L_DISCOUNT    DECIMAL(15,2) NOT NULL,
                             L_TAX         DECIMAL(15,2) NOT NULL,
                             L_RETURNFLAG  CHAR(1) NOT NULL,
                             L_LINESTATUS  CHAR(1) NOT NULL,
                             L_SHIPDATE    DATE NOT NULL,
                             L_COMMITDATE  DATE NOT NULL,
                             L_RECEIPTDATE DATE NOT NULL,
                             L_SHIPINSTRUCT CHAR(25) NOT NULL,
                             L_SHIPMODE     CHAR(10) NOT NULL,
                             L_COMMENT      VARCHAR(44) NOT NULL);

USE TPCH;
explain /*Q1*/ 
select c_custkey,
	c_name,
	sum(l_extendedprice * (1 - l_discount)) as revenue,
	c_acctbal,
	n_name,
	c_address,
	c_phone,
	c_comment
from
	CUSTOMER,
	ORDERS,
	LINEITEM,
	NATION
where
	c_custkey = o_custkey
	and l_orderkey = o_orderkey
	and o_orderdate >= date '1993-08-01'
	and o_orderdate < date '1993-08-01' + interval '3' month
	and l_returnflag = 'R'
	and c_nationkey = n_nationkey
group by
	c_custkey,
	c_name,
	c_acctbal,
	c_phone,
	n_name,
	c_address,
	c_comment
order by
	revenue desc
limit 20;

explain /*Q2*/
SELECT ps_partkey,
       Sum(ps_supplycost * ps_availqty) AS value
FROM   partsupp,
       supplier,
       nation
WHERE  ps_suppkey = s_suppkey
       AND s_nationkey = n_nationkey
       AND n_name = 'MOZAMBIQUE'
GROUP  BY ps_partkey
HAVING Sum(ps_supplycost * ps_availqty) > (SELECT
       Sum(ps_supplycost * ps_availqty) * 0.0001000000
                                           FROM   partsupp,
                                                  supplier,
                                                  nation
                                           WHERE  ps_suppkey = s_suppkey
                                                  AND s_nationkey = n_nationkey
                                                  AND n_name = 'MOZAMBIQUE')
ORDER  BY value DESC; 

explain /*Q3*/
SELECT l_shipmode,
       SUM(CASE
             WHEN o_orderpriority = '1-URGENT'
                   OR o_orderpriority = '2-HIGH' THEN 1
             ELSE 0
           END) AS high_line_count,
       SUM(CASE
             WHEN o_orderpriority <> '1-URGENT'
                  AND o_orderpriority <> '2-HIGH' THEN 1
             ELSE 0
           END) AS low_line_count
FROM   orders,
       lineitem
WHERE  o_orderkey = l_orderkey
       AND l_shipmode IN ( 'RAIL', 'FOB' )
       AND l_commitdate < l_receiptdate
       AND l_shipdate < l_commitdate
       AND l_receiptdate >= DATE '1997-01-01'
       AND l_receiptdate < DATE '1997-01-01' + interval '1' year
GROUP  BY l_shipmode
ORDER  BY l_shipmode; 

explain /*Q4*/
SELECT c_count,
       Count(*) AS custdist
FROM   (SELECT c_custkey,
               Count(o_orderkey) AS c_count
        FROM   customer
               LEFT OUTER JOIN orders
                            ON c_custkey = o_custkey
                               AND o_comment NOT LIKE '%pending%deposits%'
        GROUP  BY c_custkey) c_orders
GROUP  BY c_count
ORDER  BY custdist DESC,
          c_count DESC; 
          
explain /*Q5*/
SELECT 100.00 * SUM(CASE
                      WHEN p_type LIKE 'PROMO%' THEN l_extendedprice *
                                                     ( 1 - l_discount )
                      ELSE 0
                    END) / SUM(l_extendedprice * ( 1 - l_discount )) AS
       promo_revenue
FROM   lineitem,
       part
WHERE  l_partkey = p_partkey
       AND l_shipdate >= DATE '1996-12-01'
       AND l_shipdate < DATE '1996-12-01' + interval '1' month; 

CREATE VIEW REVENUE0 AS 
SELECT l_suppkey                                 AS supplier_no,
               SUM(l_extendedprice * ( 1 - l_discount )) AS total_revenue
        FROM   lineitem
        WHERE  l_shipdate >= DATE '1997-07-01'
               AND l_shipdate < DATE '1997-07-01' + interval '3' month
        GROUP  BY l_suppkey;

explain /*Q6*/ 
SELECT s_suppkey,
       s_name,
       s_address,
       s_phone,
       total_revenue
FROM   supplier,
       REVENUE0
WHERE  s_suppkey = supplier_no
       AND total_revenue = (SELECT Max(total_revenue)
                            FROM REVENUE0)
ORDER  BY s_suppkey;

explain /*Q7*/
SELECT p_brand,
       p_type,
       p_size,
       Count(DISTINCT ps_suppkey) AS supplier_cnt
FROM   partsupp,
       part
WHERE  p_partkey = ps_partkey
       AND p_brand <> 'Brand#34'
       AND p_type NOT LIKE 'LARGE BRUSHED%'
       AND p_size IN ( 48, 19, 12, 4,
                       41, 7, 21, 39 )
       AND ps_suppkey NOT IN (SELECT s_suppkey
                              FROM   supplier
                              WHERE  s_comment LIKE '%Customer%Complaints%')
GROUP  BY p_brand,
          p_type,
          p_size
ORDER  BY supplier_cnt DESC,
          p_brand,
          p_type,
          p_size; 
          
explain /*Q8*/
SELECT Sum(l_extendedprice) / 7.0 AS avg_yearly
FROM   lineitem,
       part
WHERE  p_partkey = l_partkey
       AND p_brand = 'Brand#44'
       AND p_container = 'WRAP PKG'
       AND l_quantity < (SELECT 0.2 * Avg(l_quantity)
                         FROM   lineitem
                         WHERE  l_partkey = p_partkey); 
                         
explain /*Q9*/
SELECT c_name,
       c_custkey,
       o_orderkey,
       o_orderdate,
       o_totalprice,
       Sum(l_quantity)
FROM   customer,
       orders,
       lineitem
WHERE  o_orderkey IN (SELECT l_orderkey
                      FROM   lineitem
                      GROUP  BY l_orderkey
                      HAVING Sum(l_quantity) > 314)
       AND c_custkey = o_custkey
       AND o_orderkey = l_orderkey
GROUP  BY c_name,
          c_custkey,
          o_orderkey,
          o_orderdate,
          o_totalprice
ORDER  BY o_totalprice DESC,
          o_orderdate
LIMIT  100; 

explain /*Q10*/
SELECT Sum(l_extendedprice * ( 1 - l_discount )) AS revenue
FROM   lineitem,
       part
WHERE  ( p_partkey = l_partkey
         AND p_brand = 'Brand#52'
         AND p_container IN ( 'SM CASE', 'SM BOX', 'SM PACK', 'SM PKG' )
         AND l_quantity >= 4
         AND l_quantity <= 4 + 10
         AND p_size BETWEEN 1 AND 5
         AND l_shipmode IN ( 'AIR', 'AIR REG' )
         AND l_shipinstruct = 'DELIVER IN PERSON' )
        OR ( p_partkey = l_partkey
             AND p_brand = 'Brand#11'
             AND p_container IN ( 'MED BAG', 'MED BOX', 'MED PKG', 'MED PACK' )
             AND l_quantity >= 18
             AND l_quantity <= 18 + 10
             AND p_size BETWEEN 1 AND 10
             AND l_shipmode IN ( 'AIR', 'AIR REG' )
             AND l_shipinstruct = 'DELIVER IN PERSON' )
        OR ( p_partkey = l_partkey
             AND p_brand = 'Brand#51'
             AND p_container IN ( 'LG CASE', 'LG BOX', 'LG PACK', 'LG PKG' )
             AND l_quantity >= 29
             AND l_quantity <= 29 + 10
             AND p_size BETWEEN 1 AND 15
             AND l_shipmode IN ( 'AIR', 'AIR REG' )
             AND l_shipinstruct = 'DELIVER IN PERSON' ); 
             
explain /*Q11*/ 
SELECT l_returnflag,
       l_linestatus,
       SUM(l_quantity)                                           AS sum_qty,
       SUM(l_extendedprice)                                      AS
       sum_base_price,
       SUM(l_extendedprice * ( 1 - l_discount ))                 AS
       sum_disc_price,
       SUM(l_extendedprice * ( 1 - l_discount ) * ( 1 + l_tax )) AS sum_charge,
       Avg(l_quantity)                                           AS avg_qty,
       Avg(l_extendedprice)                                      AS avg_price,
       Avg(l_discount)                                           AS avg_disc,
       Count(*)                                                  AS count_order
FROM   lineitem
WHERE  l_shipdate <= DATE '1998-12-01' - interval '108' day
GROUP  BY l_returnflag,
          l_linestatus
ORDER  BY l_returnflag,
          l_linestatus; 
          
explain /*Q12*/
SELECT s_name,
       s_address
FROM   supplier,
       nation
WHERE  s_suppkey IN (SELECT ps_suppkey
                     FROM   partsupp
                     WHERE  ps_partkey IN (SELECT p_partkey
                                           FROM   part
                                           WHERE  p_name LIKE 'green%')
                            AND ps_availqty > (SELECT 0.5 * SUM(l_quantity)
                                               FROM   lineitem
                                               WHERE  l_partkey = ps_partkey
                                                      AND l_suppkey = ps_suppkey
                                                      AND l_shipdate >= DATE
                                                          '1993-01-01'
                                                      AND l_shipdate < DATE
                                                          '1993-01-01' +
                                                          interval
                                                                       '1' year
                                              ))
       AND s_nationkey = n_nationkey
       AND n_name = 'ALGERIA'
ORDER  BY s_name; 

explain /*Q13*/
SELECT s_name,
       Count(*) AS numwait
FROM   supplier,
       lineitem l1,
       orders,
       nation
WHERE  s_suppkey = l1.l_suppkey
       AND o_orderkey = l1.l_orderkey
       AND o_orderstatus = 'F'
       AND l1.l_receiptdate > l1.l_commitdate
       AND EXISTS (SELECT *
                   FROM   lineitem l2
                   WHERE  l2.l_orderkey = l1.l_orderkey
                          AND l2.l_suppkey <> l1.l_suppkey)
       AND NOT EXISTS (SELECT *
                       FROM   lineitem l3
                       WHERE  l3.l_orderkey = l1.l_orderkey
                              AND l3.l_suppkey <> l1.l_suppkey
                              AND l3.l_receiptdate > l3.l_commitdate)
       AND s_nationkey = n_nationkey
       AND n_name = 'EGYPT'
GROUP  BY s_name
ORDER  BY numwait DESC,
          s_name
LIMIT  100; 

explain /*Q14*/
SELECT cntrycode,
       Count(*)       AS numcust,
       Sum(c_acctbal) AS totacctbal
FROM   (SELECT Substr(c_phone, 1, 2) AS cntrycode,
               c_acctbal
        FROM   customer
        WHERE  Substr(c_phone, 1, 2) IN ( '20', '40', '22', '30',
                                                    '39', '42', '21' )
               AND c_acctbal > (SELECT Avg(c_acctbal)
                                FROM   customer
                                WHERE  c_acctbal > 0.00
                                       AND Substr(c_phone, 1, 2) IN (
                                           '20', '40', '22', '30',
                                           '39', '42', '21' ))
               AND NOT EXISTS (SELECT *
                               FROM   orders
                               WHERE  o_custkey = c_custkey)) AS custsale
GROUP  BY cntrycode
ORDER  BY cntrycode; 

explain /*Q15*/
SELECT s_acctbal,
       s_name,
       n_name,
       p_partkey,
       p_mfgr,
       s_address,
       s_phone,
       s_comment
FROM   part,
       supplier,
       partsupp,
       nation,
       region
WHERE  p_partkey = ps_partkey
       AND s_suppkey = ps_suppkey
       AND p_size = 30
       AND p_type LIKE '%STEEL'
       AND s_nationkey = n_nationkey
       AND n_regionkey = r_regionkey
       AND r_name = 'ASIA'
       AND ps_supplycost = (SELECT Min(ps_supplycost)
                            FROM   partsupp,
                                   supplier,
                                   nation,
                                   region
                            WHERE  p_partkey = ps_partkey
                                   AND s_suppkey = ps_suppkey
                                   AND s_nationkey = n_nationkey
                                   AND n_regionkey = r_regionkey
                                   AND r_name = 'ASIA')
ORDER  BY s_acctbal DESC,
          n_name,
          s_name,
          p_partkey
LIMIT  100; 

explain /*Q16*/
SELECT   l_orderkey,
         Sum(l_extendedprice * (1 - l_discount)) AS revenue,
         o_orderdate,
         o_shippriority
FROM     customer,
         orders,
         lineitem
WHERE    c_mktsegment = 'AUTOMOBILE'
AND      c_custkey = o_custkey
AND      l_orderkey = o_orderkey
AND      o_orderdate < date '1995-03-13'
AND      l_shipdate >  date '1995-03-13'
GROUP BY l_orderkey,
         o_orderdate,
         o_shippriority
ORDER BY revenue DESC,
         o_orderdate limit 10;
         
explain /*Q17*/
SELECT o_orderpriority,
       Count(*) AS order_count
FROM   orders
WHERE  o_orderdate >= DATE '1995-01-01'
       AND o_orderdate < DATE '1995-01-01' + interval '3' month
       AND EXISTS (SELECT *
                   FROM   lineitem
                   WHERE  l_orderkey = o_orderkey
                          AND l_commitdate < l_receiptdate)
GROUP  BY o_orderpriority
ORDER  BY o_orderpriority; 

explain /*Q18*/
SELECT n_name,
       SUM(l_extendedprice * ( 1 - l_discount )) AS revenue
FROM   customer,
       orders,
       lineitem,
       supplier,
       nation,
       region
WHERE  c_custkey = o_custkey
       AND l_orderkey = o_orderkey
       AND l_suppkey = s_suppkey
       AND c_nationkey = s_nationkey
       AND s_nationkey = n_nationkey
       AND n_regionkey = r_regionkey
       AND r_name = 'MIDDLE EAST'
       AND o_orderdate >= DATE '1994-01-01'
       AND o_orderdate < DATE '1994-01-01' + interval '1' year
GROUP  BY n_name
ORDER  BY revenue DESC; 

explain /*Q19*/ 
select
	sum(l_extendedprice * l_discount) as revenue
from
	LINEITEM
where
	l_shipdate >= date '1994-01-01'
	and l_shipdate < date '1994-01-01' + interval '1' year
	and l_discount between 0.06 - 0.01 and 0.06 + 0.01
	and l_quantity < 24;

explain /*Q20*/
SELECT supp_nation,
       cust_nation,
       l_year,
       SUM(volume) AS revenue
FROM   (SELECT n1.n_name                            AS supp_nation,
               n2.n_name                            AS cust_nation,
               To_char(l_shipdate, 'yyyy')          AS l_year,
               l_extendedprice * ( 1 - l_discount ) AS volume
        FROM   supplier,
               lineitem,
               orders,
               customer,
               nation n1,
               nation n2
        WHERE  s_suppkey = l_suppkey
               AND o_orderkey = l_orderkey
               AND c_custkey = o_custkey
               AND s_nationkey = n1.n_nationkey
               AND c_nationkey = n2.n_nationkey
               AND ( ( n1.n_name = 'JAPAN'
                       AND n2.n_name = 'INDIA' )
                      OR ( n1.n_name = 'INDIA'
                           AND n2.n_name = 'JAPAN' ) )
               AND l_shipdate BETWEEN DATE '1995-01-01' AND DATE '1996-12-31')
       AS
       shipping
GROUP  BY supp_nation,
          cust_nation,
          l_year
ORDER  BY supp_nation,
          cust_nation,
          l_year; 
          
explain /*Q21*/
SELECT o_year,
       SUM(CASE
             WHEN nation = 'INDIA' THEN volume
             ELSE 0
           END) / SUM(volume) AS mkt_share
FROM   (SELECT To_char(o_orderdate, 'yyyy')         AS o_year,
               l_extendedprice * ( 1 - l_discount ) AS volume,
               n2.n_name                            AS nation
        FROM   part,
               supplier,
               lineitem,
               orders,
               customer,
               nation n1,
               nation n2,
               region
        WHERE  p_partkey = l_partkey
               AND s_suppkey = l_suppkey
               AND l_orderkey = o_orderkey
               AND o_custkey = c_custkey
               AND c_nationkey = n1.n_nationkey
               AND n1.n_regionkey = r_regionkey
               AND r_name = 'ASIA'
               AND s_nationkey = n2.n_nationkey
               AND o_orderdate BETWEEN DATE '1995-01-01' AND DATE '1996-12-31'
               AND p_type = 'SMALL PLATED COPPER') AS all_nations
GROUP  BY o_year
ORDER  BY o_year; 

explain /*Q22*/
SELECT nation,
       o_year,
       Sum(amount) AS sum_profit
FROM   (SELECT n_name
               AS
                      nation,
               To_char(o_orderdate, 'yyyy')
               AS
                      o_year,
               l_extendedprice * ( 1 - l_discount ) - ps_supplycost * l_quantity
               AS
                      amount
        FROM   part,
               supplier,
               lineitem,
               partsupp,
               orders,
               nation
        WHERE  s_suppkey = l_suppkey
               AND ps_suppkey = l_suppkey
               AND ps_partkey = l_partkey
               AND p_partkey = l_partkey
               AND o_orderkey = l_orderkey
               AND s_nationkey = n_nationkey
               AND p_name LIKE '%dim%') AS profit
GROUP  BY nation,
          o_year
ORDER  BY nation,
          o_year DESC; 
